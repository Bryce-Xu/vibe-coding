<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Performance Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        #map { height: 400px; width: 100%; margin: 20px 0; }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .metric {
            padding: 15px;
            background: #e9ecef;
            border-radius: 4px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ—ºï¸ åœ°å›¾æ€§èƒ½æµ‹è¯•</h1>
    
    <div class="test-container">
        <h2>æµ‹è¯•è¯´æ˜</h2>
        <p>è¿™ä¸ªæµ‹è¯•é¡µé¢ç”¨äºéªŒè¯åœ°å›¾ä¼˜åŒ–æ•ˆæœï¼ŒåŒ…æ‹¬ï¼š</p>
        <ul>
            <li>åœ°å›¾ç“¦ç‰‡åŠ è½½é€Ÿåº¦</li>
            <li>ä¸åŒåœ°å›¾æºçš„æ€§èƒ½å¯¹æ¯”</li>
            <li>æµè§ˆå™¨ç¼“å­˜æ•ˆæœ</li>
            <li>åœ°å›¾æ¸²æŸ“æ€§èƒ½</li>
        </ul>
    </div>

    <div class="test-container">
        <h2>æ€§èƒ½æŒ‡æ ‡</h2>
        <div class="metrics">
            <div class="metric">
                <div class="metric-value" id="tileCount">0</div>
                <div class="metric-label">å·²åŠ è½½ç“¦ç‰‡</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="loadTime">0ms</div>
                <div class="metric-label">åŠ è½½æ—¶é—´</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="cacheHit">0%</div>
                <div class="metric-label">ç¼“å­˜å‘½ä¸­ç‡</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="mapSource">-</div>
                <div class="metric-label">å½“å‰åœ°å›¾æº</div>
            </div>
        </div>
    </div>

    <div class="test-container">
        <h2>æµ‹è¯•æ“ä½œ</h2>
        <button onclick="testMapLoad()">æµ‹è¯•åœ°å›¾åŠ è½½</button>
        <button onclick="testCache()">æµ‹è¯•ç¼“å­˜æ•ˆæœ</button>
        <button onclick="testMapSources()">æµ‹è¯•ä¸åŒåœ°å›¾æº</button>
        <button onclick="clearCache()">æ¸…é™¤ç¼“å­˜</button>
    </div>

    <div class="test-container">
        <h2>æµ‹è¯•ç»“æœ</h2>
        <div id="results"></div>
    </div>

    <div class="test-container">
        <h2>åœ°å›¾é¢„è§ˆ</h2>
        <div id="map"></div>
    </div>

    <script>
        const MAP_SOURCES = [
            {
                name: 'CartoDB Positron',
                url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                subdomains: 'abcd'
            },
            {
                name: 'OpenStreetMap',
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                subdomains: 'abc'
            },
            {
                name: 'OpenStreetMap DE',
                url: 'https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png',
                subdomains: 'abc'
            }
        ];

        let tileCount = 0;
        let cacheHits = 0;
        let startTime = 0;
        let currentSource = 0;

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function updateMetrics() {
            document.getElementById('tileCount').textContent = tileCount;
            const loadTime = Date.now() - startTime;
            document.getElementById('loadTime').textContent = loadTime + 'ms';
            const cacheRate = tileCount > 0 ? Math.round((cacheHits / tileCount) * 100) : 0;
            document.getElementById('cacheHit').textContent = cacheRate + '%';
            document.getElementById('mapSource').textContent = MAP_SOURCES[currentSource]?.name || '-';
        }

        async function testMapLoad() {
            addResult('å¼€å§‹æµ‹è¯•åœ°å›¾åŠ è½½æ€§èƒ½...', 'info');
            tileCount = 0;
            cacheHits = 0;
            startTime = Date.now();

            const sydneyCenter = [-33.8688, 151.2093];
            const zoom = 11;

            // Calculate tiles needed for viewport
            const tiles = calculateTiles(sydneyCenter, zoom, 400, 400);
            addResult(`éœ€è¦åŠ è½½çº¦ ${tiles} ä¸ªç“¦ç‰‡ (ç¼©æ”¾çº§åˆ« ${zoom})`, 'info');

            // Test loading tiles
            const subdomain = MAP_SOURCES[currentSource].subdomains[0];
            const baseUrl = MAP_SOURCES[currentSource].url.replace('{s}', subdomain);

            let loaded = 0;
            const testTiles = Math.min(tiles, 20); // Test first 20 tiles

            for (let x = 0; x < Math.ceil(Math.sqrt(testTiles)); x++) {
                for (let y = 0; y < Math.ceil(Math.sqrt(testTiles)); y++) {
                    if (loaded >= testTiles) break;
                    
                    const url = baseUrl
                        .replace('{z}', zoom.toString())
                        .replace('{x}', x.toString())
                        .replace('{y}', y.toString())
                        .replace('{r}', '');

                    const tileStart = performance.now();
                    try {
                        const response = await fetch(url, { method: 'HEAD' });
                        const tileTime = performance.now() - tileStart;
                        
                        tileCount++;
                        if (response.headers.get('x-cache') === 'HIT' || response.status === 304) {
                            cacheHits++;
                        }
                        
                        if (loaded < 5) {
                            addResult(`ç“¦ç‰‡ ${x},${y}: ${Math.round(tileTime)}ms ${response.status === 304 ? '(ç¼“å­˜)' : ''}`, 
                                response.status === 304 ? 'success' : 'info');
                        }
                        loaded++;
                    } catch (error) {
                        addResult(`ç“¦ç‰‡ ${x},${y} åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                    }
                }
            }

            updateMetrics();
            const totalTime = Date.now() - startTime;
            addResult(`âœ… æµ‹è¯•å®Œæˆ: åŠ è½½äº† ${tileCount} ä¸ªç“¦ç‰‡ï¼Œè€—æ—¶ ${totalTime}msï¼Œå¹³å‡ ${Math.round(totalTime / tileCount)}ms/ç“¦ç‰‡`, 'success');
        }

        function calculateTiles(center, zoom, width, height) {
            // Approximate calculation
            const tilesPerScreen = Math.ceil(width / 256) * Math.ceil(height / 256);
            return tilesPerScreen;
        }

        async function testCache() {
            addResult('æµ‹è¯•æµè§ˆå™¨ç¼“å­˜æ•ˆæœ...', 'info');
            
            // First load
            addResult('ç¬¬ä¸€æ¬¡åŠ è½½ï¼ˆæ— ç¼“å­˜ï¼‰...', 'info');
            tileCount = 0;
            cacheHits = 0;
            startTime = Date.now();
            await testMapLoad();
            
            const firstLoadTime = Date.now() - startTime;
            
            // Wait a bit
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Second load (should use cache)
            addResult('ç¬¬äºŒæ¬¡åŠ è½½ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰...', 'info');
            tileCount = 0;
            cacheHits = 0;
            startTime = Date.now();
            await testMapLoad();
            
            const secondLoadTime = Date.now() - startTime;
            const improvement = Math.round(((firstLoadTime - secondLoadTime) / firstLoadTime) * 100);
            
            addResult(`ç¼“å­˜æ•ˆæœ: ç¬¬ä¸€æ¬¡ ${firstLoadTime}msï¼Œç¬¬äºŒæ¬¡ ${secondLoadTime}msï¼Œæå‡ ${improvement}%`, 
                improvement > 50 ? 'success' : 'warning');
        }

        async function testMapSources() {
            addResult('æµ‹è¯•ä¸åŒåœ°å›¾æºçš„æ€§èƒ½...', 'info');
            
            for (let i = 0; i < MAP_SOURCES.length; i++) {
                currentSource = i;
                addResult(`\næµ‹è¯•åœ°å›¾æº: ${MAP_SOURCES[i].name}`, 'info');
                
                tileCount = 0;
                cacheHits = 0;
                startTime = Date.now();
                
                await testMapLoad();
                
                const loadTime = Date.now() - startTime;
                addResult(`${MAP_SOURCES[i].name}: ${loadTime}ms (${tileCount} ç“¦ç‰‡)`, 
                    loadTime < 2000 ? 'success' : 'warning');
                
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        function clearCache() {
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            addResult('âœ… ç¼“å­˜å·²æ¸…é™¤ï¼ˆéœ€è¦åˆ·æ–°é¡µé¢æ‰èƒ½å®Œå…¨æ¸…é™¤ï¼‰', 'success');
        }

        // Initialize
        addResult('æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info');
        updateMetrics();
    </script>
</body>
</html>

